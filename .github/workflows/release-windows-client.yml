name: Release Windows Client

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
  workflow_call:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-windows-client:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Extract version
        id: version
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch" -or "${{ github.event_name }}" -eq "workflow_call") {
            $version = "${{ inputs.version }}"
          } else {
            $version = "${{ github.ref_name }}".TrimStart('v')
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"

      - name: Build .NET Project
        working-directory: client-windows
        run: |
          dotnet publish KioskClient.Service -c Release -o publish -r win-x64 --self-contained false

      - name: Install Playwright browsers
        working-directory: client-windows
        shell: pwsh
        run: |
          # Set PLAYWRIGHT_BROWSERS_PATH to install browsers into publish directory
          # This ensures browsers are bundled with the installer (per Playwright docs)
          $env:PLAYWRIGHT_BROWSERS_PATH = "$PWD\publish"

          # CRITICAL: Disable hard links to prevent 1-byte stub files
          # Playwright uses hard links to deduplicate browsers, but this fails on GitHub Actions
          # The PLAYWRIGHT_SKIP_BROWSER_GC=1 prevents the use of .links folder
          $env:PLAYWRIGHT_SKIP_BROWSER_GC = "1"

          Write-Host "Installing Playwright browsers to: $env:PLAYWRIGHT_BROWSERS_PATH"
          Write-Host "PLAYWRIGHT_SKIP_BROWSER_GC: $env:PLAYWRIGHT_SKIP_BROWSER_GC (disables hard links)"

          # Use the official playwright.ps1 script generated by dotnet publish
          # Reference: https://playwright.dev/dotnet/docs/library
          Write-Host "=== Running playwright.ps1 install ==="
          pwsh publish/playwright.ps1 install chromium --with-deps
          $installExitCode = $LASTEXITCODE
          Write-Host "playwright.ps1 exit code: $installExitCode"
          Write-Host ""

          # Verify installation with detailed debugging
          Write-Host "=== Checking for installed browsers ==="
          Write-Host "Current directory: $PWD"
          Write-Host ""

          Write-Host "=== All directories in publish folder: ==="
          Get-ChildItem "publish" -Directory | ForEach-Object {
            Write-Host "  - $($_.Name)"
          }
          Write-Host ""

          Write-Host "=== Searching for chrome.exe recursively: ==="
          $chromeExes = Get-ChildItem "publish" -Recurse -Filter "chrome.exe" -ErrorAction SilentlyContinue
          if ($chromeExes) {
            $chromeExes | ForEach-Object { Write-Host "  Found: $($_.FullName)" }
          } else {
            Write-Host "  No chrome.exe files found"
          }
          Write-Host ""

          # Check for chromium in various possible locations
          $foundBrowser = $false

          # Try pattern 1: chromium-*/chrome-win64/chrome.exe
          if (Test-Path "publish/chromium-*/chrome-win64/chrome.exe") {
            Write-Host "✅ Found chromium in publish/chromium-*/chrome-win64/"
            $foundBrowser = $true
          }

          # Try pattern 2: chromium_headless_shell-*/chrome-win64/chrome.exe
          if (Test-Path "publish/chromium_headless_shell-*/chrome-win64/chrome.exe") {
            Write-Host "✅ Found chromium in publish/chromium_headless_shell-*/chrome-win64/"
            $foundBrowser = $true
          }

          # Try pattern 3: Any folder ending with a number/version
          $chromiumDirs = Get-ChildItem "publish" -Directory | Where-Object { $_.Name -match "chromium" }
          if ($chromiumDirs) {
            Write-Host "✅ Found chromium-related directories:"
            $chromiumDirs | ForEach-Object {
              Write-Host "  - $($_.Name)"
              Write-Host "    Contents:"
              Get-ChildItem $_.FullName | ForEach-Object { Write-Host "      - $($_.Name)" }
            }
          }

          # Check what's inside chrome-win64 folder specifically
          Write-Host ""
          Write-Host "=== Contents of chrome-win64 folder: ==="
          if (Test-Path "publish/chromium-1200/chrome-win64") {
            Write-Host "chrome-win64 folder exists, listing contents:"
            Get-ChildItem "publish/chromium-1200/chrome-win64" -Force | ForEach-Object {
              Write-Host "  - $($_.Name) ($($_.Length) bytes)"
            }
            Write-Host ""
            Write-Host "Checking specifically for chrome.exe:"
            if (Test-Path "publish/chromium-1200/chrome-win64/chrome.exe") {
              Write-Host "  ✅ chrome.exe EXISTS at publish/chromium-1200/chrome-win64/chrome.exe"
              $foundBrowser = $true
            } else {
              Write-Host "  ❌ chrome.exe NOT FOUND at publish/chromium-1200/chrome-win64/chrome.exe"
              Write-Host "  Searching for any .exe files in chrome-win64:"
              Get-ChildItem "publish/chromium-1200/chrome-win64" -Filter "*.exe" -Force | ForEach-Object {
                Write-Host "    - Found EXE: $($_.Name)"
              }
            }
          } else {
            Write-Host "chrome-win64 folder does NOT exist"
          }
          Write-Host ""

          if (-not $foundBrowser) {
            Write-Error "❌ Failed to install Chromium browser - chrome.exe not found in chrome-win64 folder"
            exit 1
          }

      - name: Download Inno Setup
        shell: pwsh
        run: |
          $InnoSetupUrl = "https://jrsoftware.org/download.php/is.exe"
          Invoke-WebRequest -Uri $InnoSetupUrl -OutFile "$env:TEMP\innosetup.exe"
          Start-Process -FilePath "$env:TEMP\innosetup.exe" -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-" -Wait

      - name: Build Installer
        working-directory: client-windows
        shell: pwsh
        run: |
          # Update version in Setup.iss
          $setupContent = Get-Content Setup.iss -Raw
          $setupContent = $setupContent -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"${{ steps.version.outputs.VERSION }}`""
          Set-Content Setup.iss -Value $setupContent

          # Compile with Inno Setup
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" Setup.iss

      - name: Rename installer
        working-directory: client-windows
        shell: pwsh
        run: |
          $oldName = "TheiaCastKioskClient-Setup.exe"
          $newName = "TheiaCast-Client-Windows-v${{ steps.version.outputs.VERSION }}-Setup.exe"
          if (Test-Path $oldName) {
            Rename-Item $oldName $newName
            echo "Renamed to: $newName"
          }

      - name: Upload Release Asset
        uses: actions/upload-artifact@v4
        with:
          name: windows-client-installer
          path: client-windows/TheiaCast-Client-Windows-v${{ steps.version.outputs.VERSION }}-Setup.exe

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: TheiaCast v${{ steps.version.outputs.VERSION }}
          files: client-windows/TheiaCast-Client-Windows-v${{ steps.version.outputs.VERSION }}-Setup.exe
          draft: false
          prerelease: false
          body: |
            ## TheiaCast Windows Client v${{ steps.version.outputs.VERSION }}

            ### Installation
            Download and run `TheiaCast-Client-Windows-v${{ steps.version.outputs.VERSION }}-Setup.exe`

            ### Requirements
            - Windows 10 or later
            - .NET 10 Runtime (automatically installed if missing)

            ### What's Included
            - Windows installer with auto-start via Task Scheduler
            - Bundled Chromium browser for kiosk display
            - Configuration wizard for server connection
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
